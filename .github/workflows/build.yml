name: Build and Release

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: "5.9"

      - name: Cache Swift packages
        uses: actions/cache@v3
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build
        run: swift build -v

      - name: Run tests
        run: swift test -v || echo "No tests configured"

      - name: Build Release
        run: swift build -c release -v

      - name: Package App
        run: |
          # Copy binary to app bundle
          cp .build/release/AppLocker AppLocker.app/Contents/MacOS/AppLocker

          # Sign with ad-hoc signature (for CI builds)
          codesign --force --deep --sign - \
            --entitlements dist/entitlements.plist \
            --options runtime \
            AppLocker.app

          # Create release directory
          mkdir -p release
          cp -R AppLocker.app release/

          # Create DMG
          hdiutil create -volname "AppLocker" \
            -srcfolder release/AppLocker.app \
            -ov -format UDZO \
            release/AppLocker-CI.dmg

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AppLocker-Build
          path: |
            release/AppLocker.app
            release/AppLocker-CI.dmg
          retention-days: 30

  release:
    needs: build
    runs-on: macos-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: AppLocker-Build
          path: release

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Rename DMG with version
        run: |
          mv release/AppLocker-CI.dmg "release/AppLocker-${{ steps.get_version.outputs.VERSION }}.dmg"

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/AppLocker-${{ steps.get_version.outputs.VERSION }}.dmg
          draft: false
          prerelease: false
          generate_release_notes: true
          name: "AppLocker ${{ steps.get_version.outputs.VERSION }}"
          body: |
            ## AppLocker ${{ steps.get_version.outputs.VERSION }}

            ### What's New
            - Passcode protection with Touch ID/Face ID support
            - App blocking engine
            - Schedule-based locking
            - Usage statistics and activity log
            - Export/import configuration
            - Cross-device alerts

            ### Installation
            1. Download `AppLocker-${{ steps.get_version.outputs.VERSION }}.dmg`
            2. Open the DMG and drag AppLocker to Applications
            3. Launch AppLocker and grant Accessibility permissions when prompted

            ### Requirements
            - macOS 13.0 (Ventura) or later
            - Apple Silicon or Intel Mac
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
