name: Build and Release

on:
  push:
    branches: [main, master]
    tags:
      - "v*"
  pull_request:
    branches: [main, master]

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: "5.9"

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-spm-${{ hashFiles('Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build
        run: swift build -v

      - name: Run tests
        run: swift test -v 2>&1 || echo "No tests configured yet"

      - name: Build Release
        run: swift build -c release -v

      - name: Determine version
        id: version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"
          else
            echo "VERSION=0.0.0-dev" >> "$GITHUB_OUTPUT"
          fi

      - name: Package App Bundle
        env:
          APP_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          set -e

          APP_BUNDLE="AppLocker.app"
          CONTENTS="$APP_BUNDLE/Contents"
          MACOS_DIR="$CONTENTS/MacOS"
          RESOURCES_DIR="$CONTENTS/Resources"

          # Create app bundle structure
          mkdir -p "$MACOS_DIR"
          mkdir -p "$RESOURCES_DIR"

          # Copy the built binary
          cp .build/release/AppLocker "$MACOS_DIR/AppLocker"

          # Create Info.plist
          cat > "$CONTENTS/Info.plist" << PLIST
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleName</key>
              <string>AppLocker</string>
              <key>CFBundleDisplayName</key>
              <string>AppLocker</string>
              <key>CFBundleIdentifier</key>
              <string>com.applocker.AppLocker</string>
              <key>CFBundleVersion</key>
              <string>${APP_VERSION}</string>
              <key>CFBundleShortVersionString</key>
              <string>${APP_VERSION}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleExecutable</key>
              <string>AppLocker</string>
              <key>CFBundleIconFile</key>
              <string>AppIcon</string>
              <key>LSMinimumSystemVersion</key>
              <string>13.0</string>
              <key>LSUIElement</key>
              <false/>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSSupportsAutomaticGraphicsSwitching</key>
              <true/>
          </dict>
          </plist>
          PLIST

          # Copy icon if available
          if [ -f "icon.png" ]; then
            cp icon.png "$RESOURCES_DIR/AppIcon.png"
          fi

      - name: Sign App Bundle
        run: |
          codesign --force --deep --sign - \
            --entitlements dist/entitlements.plist \
            --options runtime \
            AppLocker.app 2>&1 || echo "Ad-hoc signing completed with warnings"

          codesign --verify --deep AppLocker.app 2>&1 || echo "Signature verification note: ad-hoc signed"

      - name: Create DMG
        env:
          APP_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          set -e
          mkdir -p release

          # Create temporary directory with app and Applications symlink
          DMG_STAGING=$(mktemp -d)
          cp -R AppLocker.app "$DMG_STAGING/"
          ln -s /Applications "$DMG_STAGING/Applications"

          # Create DMG
          hdiutil create -volname "AppLocker" \
            -srcfolder "$DMG_STAGING" \
            -ov -format UDZO \
            "release/AppLocker-${APP_VERSION}.dmg"

          rm -rf "$DMG_STAGING"

          echo "DMG created:"
          ls -la release/

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AppLocker-Build
          path: release/AppLocker-*.dmg
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: AppLocker-Build
          path: release

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: List release artifacts
        run: ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/AppLocker-*.dmg
          draft: false
          prerelease: false
          generate_release_notes: true
          name: "AppLocker v${{ steps.get_version.outputs.VERSION }}"
          body: |
            ## AppLocker v${{ steps.get_version.outputs.VERSION }}

            ### Installation
            1. Download `AppLocker-${{ steps.get_version.outputs.VERSION }}.dmg`
            2. Open the DMG and drag AppLocker to Applications
            3. Launch AppLocker and grant Accessibility permissions when prompted

            ### Requirements
            - macOS 13.0 (Ventura) or later
            - Apple Silicon or Intel Mac
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
